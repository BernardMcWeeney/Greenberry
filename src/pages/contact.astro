---
import Layout from '../layouts/Layout.astro';
import Container from '../components/common/Container.astro';
import Button from '../components/common/Button.astro';
import Badge from '../components/ui/Badge.astro';
import PageHeader from '../components/common/PageHeader.astro';
import { COMPANY, SOCIAL_LINKS } from '../data/config';

const socialLinks = [
  { icon: "fa-brands fa-facebook", path: SOCIAL_LINKS.facebook, color: "hover:bg-blue-500", name: "Facebook" },
  { icon: "fa-brands fa-x-twitter", path: SOCIAL_LINKS.x, color: "hover:bg-blue-400", name: "X" },
  { icon: "fa-brands fa-linkedin", path: SOCIAL_LINKS.linkedin, color: "hover:bg-blue-700", name: "LinkedIn" },
  { icon: "fa-brands fa-instagram", path: SOCIAL_LINKS.instagram, color: "hover:bg-pink-600", name: "Instagram" },
];
---

<Layout title="Contact Us | Greenberry">
  <!-- Page Header using the reusable component -->
  <PageHeader
    title="Let's Start Your Project"
    description="Ready to discuss your project? We're here to help you create a website that works for your business."
    backgroundVariant="decorated"
    badgeText="GET IN TOUCH"
    highlightedText="Project"
    paddingY="md"
  />

  <section class="py-16 bg-white dark:bg-gray-900">
    <Container>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
        <!-- Contact Form Card with Greenberry styling -->
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-100 dark:border-gray-700 p-8 hover:shadow-xl transition-all relative overflow-hidden">
          <!-- Decorative corner accent -->
          <div class="absolute -top-10 -right-10 w-20 h-20 bg-[#17A34A]/10 rounded-full filter blur-xl"></div>
          
          <div class="badge-wrapper mb-4">
            <Badge text="SEND US A MESSAGE" variant="primary" size="md" />
          </div>
          
          <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">
            Let us know how we can help
          </h2>

          <!-- Form Status Messages -->
          <div id="form-status-success" class="hidden mb-6 p-4 rounded-lg bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400">
            <div class="flex items-center">
              <i class="fa-solid fa-circle-check mr-2"></i>
              <span>Thank you! Your message has been sent successfully.</span>
            </div>
          </div>

          <div id="form-status-error" class="hidden mb-6 p-4 rounded-lg bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400">
            <div class="flex items-center">
              <i class="fa-solid fa-circle-exclamation mr-2"></i>
              <span id="error-message">There was a problem sending your message. Please try again.</span>
            </div>
          </div>
          
          <form id="contact-form" class="space-y-6 relative z-10">
            <div>
              <label for="full-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                Full Name
              </label>
              <input
                type="text"
                id="full-name"
                name="full-name"
                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-3-2 focus:ring-3-[#17A34A] focus:border-[#17A34A] transition-all"
                required
              />
            </div>
            
            <div>
              <label for="email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                Email
              </label>
              <input
                type="email"
                id="email"
                name="email"
                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-3-2 focus:ring-3-[#17A34A] focus:border-[#17A34A] transition-all"
                required
              />
            </div>
            
            <div>
              <label for="phone" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                Phone Number
              </label>
              <div class="relative">
                <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-gray-500 dark:text-gray-400">
                  <i class="fa-solid fa-phone text-sm"></i>
                </div>
                <input
                  type="tel"
                  id="phone"
                  name="phone"
                  class="w-full pl-10 pr-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-3-2 focus:ring-3-[#17A34A] focus:border-[#17A34A] transition-all"
                />
              </div>
            </div>
            
            <div>
              <label for="service" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                I'm interested in
              </label>
              <select
                id="service"
                name="service"
                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-3-2 focus:ring-3-[#17A34A] focus:border-[#17A34A] transition-all"
              >
                <option value="">Select a service</option>

                <!-- Core offerings -->
                <optgroup label="Greenberry Products">
                  <option value="care">Website Care Plans</option>
                  <option value="plans">Website Plans</option>
                  <option value="custom">Custom Quote</option>
                </optgroup>

                <!-- Suites -->
                <optgroup label="Suites">
                  <option value="parish-websites">Parish Website Suite</option>
                  <option value="club-websites">Club Website Suite</option>
                  <option value="school-websites">School Website Suite</option>
                  <option value="business-websites">Business Website Suite</option>
                </optgroup>

                <!-- Other services -->
                <optgroup label="Other Services">
                  <option value="seo">SEO Services</option>
                  <option value="email">Email Solutions</option>
                  <option value="email">Security Solutions</option>
                  <option value="other">Other</option>
                </optgroup>
              </select>
            </div>
            
            <div>
              <label for="message" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                Message
              </label>
              <textarea
                id="message"
                name="message"
                rows="4"
                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-3-2 focus:ring-3-[#17A34A] focus:border-[#17A34A] transition-all"
                required
              ></textarea>
            </div>
            
            <!-- Add Turnstile widget -->
            <div class="flex justify-center mb-4">
              <div class="cf-turnstile" data-sitekey="0x4AAAAAAAWsI1fJREzBYF91" data-theme="auto"></div>
            </div>
            
            <Button id="submit-button" type="submit" size="lg" class="w-full justify-center font-medium shadow-md hover:shadow-lg hover:shadow-[#17A34A]/10">
              Send Message
              <i class="fa-solid fa-paper-plane ml-2"></i>
            </Button>
            
            <p class="text-sm text-gray-500 dark:text-gray-400 text-center">
              We respect your privacy and will never share your information.
            </p>
          </form>
        </div>
        
        <!-- Contact Info Card with Greenberry styling -->
        <div class="space-y-8">
          <div class="bg-[#17A34A] text-white rounded-2xl shadow-lg p-8 relative overflow-hidden">
            <!-- Decorative elements -->
            <div class="absolute -top-10 -right-10 w-20 h-20 bg-white/10 rounded-full filter blur-xl"></div>
            <div class="absolute -bottom-10 -left-10 w-20 h-20 bg-white/10 rounded-full filter blur-xl"></div>
            
            <h2 class="text-2xl font-bold mb-6 text-white">Direct Contact</h2>
            
            <div class="space-y-6 relative z-10">
              <div class="flex gap-4 items-start">
                <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-white shrink-0">
                  <i class="fa-solid fa-envelope"></i>
                </div>
                <div>
                  <h3 class="text-lg font-medium text-white">Email Us</h3>
                  <p class="mt-1 text-white/90">
                    <a href={`mailto:${COMPANY.email}`} class="hover:underline">
                      {COMPANY.email}
                    </a>
                  </p>
                  <p class="mt-1 text-sm text-white/70">
                    We'll respond within 24 hours
                  </p>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Office Information -->
          <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-md border border-gray-100 dark:border-gray-700 p-8">
            <div class="flex gap-4 items-start">
              <div class="w-10 h-10 rounded-full bg-[#17A34A]/10 flex items-center justify-center text-[#17A34A] shrink-0">
                <i class="fa-solid fa-location-dot"></i>
              </div>
              <div>
                <h3 class="text-lg font-medium text-gray-900 dark:text-white">Office</h3>
                <p class="mt-1 text-gray-600 dark:text-gray-300">
                  {COMPANY.address}
                </p>
                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                  We primarily work remotely, but are available for in-person meetings across Ireland
                </p>
              </div>
            </div>
          </div>
          
          <!-- Working Hours -->
          <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-md border border-gray-100 dark:border-gray-700 p-8">
            <div class="flex gap-4 items-start">
              <div class="w-10 h-10 rounded-full bg-[#17A34A]/10 flex items-center justify-center text-[#17A34A] shrink-0">
                <i class="fa-solid fa-clock"></i>
              </div>
              <div>
                <h3 class="text-lg font-medium text-gray-900 dark:text-white">Working Hours</h3>
                <p class="mt-1 text-gray-600 dark:text-gray-300">
                  Monday-Friday: 9am-5pm
                </p>
                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                  Weekend: Closed
                </p>
              </div>
            </div>
          </div>
          
          <!-- Social Media -->
          <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-md border border-gray-100 dark:border-gray-700 p-8">
            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4 flex items-center">
              <span class="mr-2 text-[#17A34A]"><i class="fa-solid fa-share-nodes"></i></span>
              Find us online
            </h3>
            <div class="flex gap-4 mt-4">
              {socialLinks.map(social => (
                <a
                  href={social.path}
                  target="_blank"
                  rel="noopener noreferrer"
                  class={`w-10 h-10 rounded-full bg-white dark:bg-gray-700 flex items-center justify-center text-gray-600 ${social.color} hover:bg-[#17A34A] hover:text-white dark:text-gray-400 dark:hover:bg-[#17A34A] dark:hover:text-white transition-colors shadow-xs hover:shadow-md`}
                  aria-label={`Follow us on ${social.name}`}
                >
                  <i class={social.icon}></i>
                </a>
              ))}
            </div>
          </div>
      </div>
    </Container>
  </section>
</Layout>

<script is:inline>
  document.addEventListener('DOMContentLoaded', () => {
    // --- Preselect logic for the Service selector ---
    const selectEl = document.getElementById('service');

    // Map URL paths to option values
    const serviceMapFromPath = [
      { test: p => p.startsWith('/care'), value: 'care' },
      { test: p => p.startsWith('/plans'), value: 'plans' },
      { test: p => p.includes('/suites/parish-websites'), value: 'parish' },
      { test: p => p.includes('/suites/club-websites'), value: 'club' },
      { test: p => p.includes('/suites/school-websites'), value: 'school' },
      { test: p => p.includes('/suites/business-websites'), value: 'business' },
    ];

    function setServiceValue(val) {
      if (!selectEl) return;
      const hasOption = Array.from(selectEl.options).some(o => o.value === val);
      if (hasOption) selectEl.value = val;
    }

    try {
      const url = new URL(window.location.href);
      // Support both ?service= and ?suite= just in case
      let svc = url.searchParams.get('service') || url.searchParams.get('suite');

      if (!svc && document.referrer) {
        const ref = new URL(document.referrer);
        if (ref.hostname === window.location.hostname) {
          const path = ref.pathname.toLowerCase();
          const hit = serviceMapFromPath.find(m => m.test(path));
          if (hit) svc = hit.value;
        }
      }

      if (svc) setServiceValue(svc);
    } catch (e) {
      console.warn('Preselect error:', e);
    }

    // --- Existing form submit logic ---
    const contactForm = document.getElementById('contact-form');
    const submitButton = document.getElementById('submit-button');
    const successMessage = document.getElementById('form-status-success');
    const errorMessage = document.getElementById('form-status-error');
    const errorText = document.getElementById('error-message');
    
    if (contactForm) {
      contactForm.addEventListener('submit', function(e) {
        // Explicitly prevent default to stop page refresh
        e.preventDefault();
        e.stopPropagation();
        
        // Disable submit button and show loading state
        if (submitButton) {
          submitButton.disabled = true;
          submitButton.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin mr-2"></i> Sending...';
        }
        
        // Hide any previous status messages
        if (successMessage) successMessage.classList.add('hidden');
        if (errorMessage) errorMessage.classList.add('hidden');
        
        // Create form data object
        const formData = new FormData(contactForm);
        
        // Use fetch API with explicit promise handling
        fetch('/api/contact', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(result => {
          if (result.success) {
            // Show success message
            if (successMessage) successMessage.classList.remove('hidden');
            
            // Reset the form
            contactForm.reset();
          } else {
            // Show error message
            if (errorText) errorText.textContent = result.message || 'There was a problem sending your message. Please try again.';
            if (errorMessage) errorMessage.classList.remove('hidden');
          }
        })
        .catch(error => {
          console.error('Error submitting form:', error);
          
          // Show error message
          if (errorText) errorText.textContent = 'There was a problem connecting to the server. Please try again later.';
          if (errorMessage) errorMessage.classList.remove('hidden');
        })
        .finally(() => {
          // Re-enable submit button
          if (submitButton) {
            submitButton.disabled = false;
            submitButton.innerHTML = 'Send Message <i class="fa-solid fa-paper-plane ml-2"></i>';
          }
        });
        
        // Return false to ensure the form doesn't submit normally
        return false;
      });
    }
  });
</script>
