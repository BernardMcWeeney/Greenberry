---
import Container from './Container.astro';
import Button from './Button.astro';
import { NAVIGATION } from '../../config';

const navItems = NAVIGATION.main;
---

<header class="sticky top-0 z-50 bg-white/95 dark:bg-gray-900/95 border-b border-gray-200 dark:border-gray-800 backdrop-blur-md shadow-sm">
  <Container>
    <div class="py-4 flex justify-between items-center">
      <!-- Logo with improved animation -->
      <a href="/" class="flex items-center gap-2 group">
        <div class="w-10 h-10 bg-gradient-to-br from-greenberry-50 to-greenberry-200 dark:from-greenberry-900/30 dark:to-greenberry-800/30 rounded-lg flex items-center justify-center text-greenberry-600 dark:text-greenberry-400 group-hover:scale-110 group-hover:rotate-3 transition-all duration-300 shadow-sm">
          <i class="fa-solid fa-leaf text-xl group-hover:animate-pulse"></i>
        </div>
        <span class="font-bold text-xl text-gray-900 dark:text-white">
          <span class="text-greenberry-600 dark:text-greenberry-400 relative inline-block">
            Greenberry
            <span class="absolute -bottom-1 left-0 w-full h-0.5 bg-greenberry-500/40 transform origin-left scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></span>
          </span>
        </span>
      </a>

      <!-- Desktop Navigation with hover effects -->
      <nav class="hidden md:flex items-center gap-8">
        {navItems.map(item => (
          <a 
            href={item.href} 
            class="font-medium text-gray-700 hover:text-greenberry-600 dark:text-gray-200 dark:hover:text-greenberry-400 transition-colors relative group py-1"
          >
            {item.name}
            <span class="absolute -bottom-1 left-0 w-0 h-0.5 bg-greenberry-500 group-hover:w-full transition-all duration-300"></span>
          </a>
        ))}
        <div class="flex items-center gap-4 ml-4">
          <!-- Dark Mode Toggle -->
          <button 
            id="theme-toggle" 
            class="p-2 text-gray-600 hover:text-greenberry-600 dark:text-gray-300 dark:hover:text-greenberry-400 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors focus:outline-none relative"
            aria-label="Toggle dark mode"
          >
            <i class="fa-solid fa-sun hidden dark:block text-xl"></i>
            <i class="fa-solid fa-moon block dark:hidden text-xl"></i>
          </button>
          
          <a 
            href="/customer-portal" 
            class="px-4 py-2 text-sm rounded-md border-2 border-greenberry-600 text-greenberry-600 hover:bg-greenberry-50 dark:border-greenberry-500 dark:text-greenberry-400 dark:hover:bg-gray-800 font-medium transition-colors"
          >
            Customer Portal
          </a>
          <Button href="/contact" variant="primary" size="sm" class="transform hover:scale-105 shadow-md hover:shadow-lg hover:shadow-greenberry-500/20">
            Get Started
            <span class="ml-1 opacity-80 group-hover:translate-x-1 transition-transform duration-300">â†’</span>
          </Button>
        </div>
      </nav>

      <!-- Mobile header controls with fixed width to prevent shifting -->
      <div class="flex items-center gap-2 md:hidden">
        <!-- Dark Mode Toggle (Mobile) -->
        <button 
          id="theme-toggle-mobile" 
          class="w-10 h-10 flex items-center justify-center text-gray-600 hover:text-greenberry-600 dark:text-gray-300 dark:hover:text-greenberry-400 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors focus:outline-none relative"
          aria-label="Toggle dark mode"
        >
          <i class="fa-solid fa-sun hidden dark:block text-xl absolute inset-0 flex items-center justify-center transition-opacity duration-150"></i>
          <i class="fa-solid fa-moon block dark:hidden text-xl absolute inset-0 flex items-center justify-center transition-opacity duration-150"></i>
        </button>
        
        <!-- Mobile menu toggle with fixed width and smoother transitions -->
        <button 
          id="menu-toggle"
          class="w-10 h-10 flex items-center justify-center text-gray-600 hover:text-greenberry-600 rounded-lg hover:bg-gray-100 focus:outline-none dark:text-gray-300 dark:hover:bg-gray-800 transition-colors relative overflow-hidden"
          aria-label="Toggle mobile menu"
        >
          <span class="absolute inset-0 bg-greenberry-100 dark:bg-greenberry-900/30 transform scale-0 rounded-lg transition-transform duration-300 ease-in-out origin-center" id="menu-toggle-bg"></span>
          <div class="w-6 h-6 relative">
            <!-- Using separate spans for the menu icon bars for smoother transitions -->
            <span id="bar-top" class="absolute h-0.5 w-6 bg-current rounded-full transform transition-transform duration-200 ease-out" style="top: 30%;"></span>
            <span id="bar-middle" class="absolute h-0.5 w-6 bg-current rounded-full transform transition-opacity duration-200 ease-out" style="top: 50%; transform: translateY(-50%);"></span>
            <span id="bar-bottom" class="absolute h-0.5 w-6 bg-current rounded-full transform transition-transform duration-200 ease-out" style="bottom: 30%;"></span>
          </div>
        </button>
      </div>
    </div>
  </Container>

  <!-- Mobile Navigation with improved animation -->
  <div id="mobile-menu" class="hidden md:hidden bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-800 transition-all duration-200 ease-in-out">
    <Container>
      <div class="py-6 space-y-6">
        <nav class="flex flex-col space-y-5">
          {navItems.map((item, index) => (
            <a 
              href={item.href} 
              class="mobile-nav-item font-medium text-gray-800 hover:text-greenberry-600 dark:text-gray-200 dark:hover:text-greenberry-400 transition-colors text-lg px-1 flex items-center transform hover:translate-x-2 transition-transform duration-300 hover:scale-[1.01] opacity-0 translate-y-2"
              style={`transition-delay: ${index * 50}ms;`}
            >
              {item.name}
              <span class="ml-auto text-gray-400 text-sm">
                <i class="fa-solid fa-chevron-right"></i>
              </span>
            </a>
          ))}
        </nav>
        <div class="flex flex-col gap-3 pt-5 border-t border-gray-100 dark:border-gray-800">
          <a 
            href="/customer-portal" 
            class="mobile-nav-item px-4 py-3 rounded-md border-2 border-greenberry-600 text-greenberry-600 hover:bg-greenberry-50 dark:border-greenberry-500 dark:text-greenberry-400 dark:hover:bg-gray-800 font-medium transition-colors text-center transform hover:scale-[1.02] opacity-0 translate-y-2"
          >
            Customer Portal
          </a>
          <Button href="/contact" variant="primary" size="md" block={true} class="mobile-nav-item transform hover:scale-[1.02] shadow-md hover:shadow-lg hover:shadow-greenberry-500/20 opacity-0 translate-y-2">
            Get Started
            <i class="fa-solid fa-arrow-right ml-2 group-hover:translate-x-1 transition-transform duration-300"></i>
          </Button>
        </div>
      </div>
    </Container>
  </div>
</header>

<script>
  // Enhanced mobile menu toggle with improved animations
  const menuToggle = document.getElementById('menu-toggle');
  const mobileMenu = document.getElementById('mobile-menu');
  const menuToggleBg = document.getElementById('menu-toggle-bg');
  const barTop = document.getElementById('bar-top');
  const barMiddle = document.getElementById('bar-middle');
  const barBottom = document.getElementById('bar-bottom');
  const mobileNavItems = document.querySelectorAll('.mobile-nav-item');

  if (menuToggle && mobileMenu && menuToggleBg && barTop && barMiddle && barBottom) {
    menuToggle.addEventListener('click', () => {
      // Toggle background effect
      if (menuToggleBg.classList.contains('scale-0')) {
        menuToggleBg.classList.remove('scale-0');
        menuToggleBg.classList.add('scale-100');
      } else {
        menuToggleBg.classList.remove('scale-100');
        menuToggleBg.classList.add('scale-0');
      }
      
      // Animate the menu icon immediately (no delay)
      if (mobileMenu.classList.contains('hidden')) {
        // Transform bars to X shape
        barTop.style.transform = 'translateY(250%) rotate(45deg)';
        barMiddle.style.opacity = '0';
        barBottom.style.transform = 'translateY(-250%) rotate(-45deg)';
        
        // Show mobile menu
        mobileMenu.classList.remove('hidden');
        mobileMenu.style.maxHeight = '0';
        mobileMenu.style.opacity = '0';
        
        // Force reflow to enable animation
        mobileMenu.offsetHeight;
        
        // Animate the menu
        mobileMenu.style.maxHeight = '500px';
        mobileMenu.style.opacity = '1';
        
        // Animate each nav item with staggered delay
        mobileNavItems.forEach((item, index) => {
          setTimeout(() => {
            item.style.opacity = '1';
            item.style.transform = 'translateY(0)';
          }, 100 + (index * 50));
        });
      } else {
        // Transform X shape back to bars
        barTop.style.transform = 'translateY(0) rotate(0)';
        barMiddle.style.opacity = '1';
        barBottom.style.transform = 'translateY(0) rotate(0)';
        
        // Hide the mobile nav items first
        mobileNavItems.forEach(item => {
          item.style.opacity = '0';
          item.style.transform = 'translateY(1rem)';
        });
        
        // Animate out the menu
        mobileMenu.style.maxHeight = '0';
        mobileMenu.style.opacity = '0';
        
        // Hide after animation completes
        setTimeout(() => {
          mobileMenu.classList.add('hidden');
          
          // Reset styles for next opening
          mobileNavItems.forEach(item => {
            item.style.transitionDelay = '0ms';
          });
        }, 200);
      }
    });
  }

  // Dark mode toggle functionality with no delay
  function setupThemeToggle(buttonId) {
    const themeToggle = document.getElementById(buttonId);
    
    if (themeToggle) {
      themeToggle.addEventListener('click', () => {
        // Toggle dark mode immediately
        if (document.documentElement.classList.contains('dark')) {
          document.documentElement.classList.remove('dark');
          localStorage.theme = 'light';
        } else {
          document.documentElement.classList.add('dark');
          localStorage.theme = 'dark';
        }
        
        // Add ripple effect
        const ripple = document.createElement('span');
        ripple.classList.add('ripple-effect');
        themeToggle.appendChild(ripple);
        
        // Remove ripple after animation
        setTimeout(() => {
          ripple.remove();
        }, 1000);
      });
    }
  }
  
  // Setup both desktop and mobile dark mode toggles
  setupThemeToggle('theme-toggle');
  setupThemeToggle('theme-toggle-mobile');
  
  // Initialize dark mode based on system preference or saved setting
  const darkModeMediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
  
  // Set dark mode based on local storage or system preference
  if (localStorage.theme === 'dark' || (!('theme' in localStorage) && darkModeMediaQuery.matches)) {
    document.documentElement.classList.add('dark');
  } else {
    document.documentElement.classList.remove('dark');
  }
  
  // Listen for system dark mode preference changes
  darkModeMediaQuery.addEventListener('change', (e) => {
    if (!('theme' in localStorage)) {
      if (e.matches) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
    }
  });
</script>

<style>
  /* Ripple effect for theme toggle */
  .ripple-effect {
    position: absolute;
    border-radius: 50%;
    background-color: rgba(34, 197, 94, 0.2);
    width: 100%;
    height: 100%;
    transform: scale(0);
    animation: ripple 1s linear;
    top: 0;
    left: 0;
    pointer-events: none;
  }
  
  @keyframes ripple {
    to {
      transform: scale(2.5);
      opacity: 0;
    }
  }
  
  /* Smooth transitions for mobile menu */
  #mobile-menu {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-in-out, opacity 0.2s ease-in-out;
  }
  
  /* Nav items transition */
  .mobile-nav-item {
    transition: opacity 0.3s ease-out, transform 0.3s ease-out;
  }
</style>